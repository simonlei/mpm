# 更新日志

## v1.5.2 - 2025-12-16

### ✨ 优化：照片详情右侧展示完整信息

重新设计照片查看器布局，在右侧展示完整的照片信息。

#### 🎯 核心改进

**1. 左右布局**
- ✅ 左侧：照片预览（占据主要空间）
- ✅ 右侧：详细信息面板（固定宽度 400px）
- ✅ 响应式设计，信息面板可独立滚动

**2. 完整信息展示**

右侧信息面板按顺序展示：
- ✅ **大小**：文件大小（自动转换单位：B/KB/MB/GB）
- ✅ **宽度**：照片宽度（px）
- ✅ **高度**：照片高度（px）
- ✅ **描述**：照片描述（如有）
- ✅ **时间**：拍摄时间
- ✅ **标签**：照片标签（如有）
- ✅ **地址**：拍摄地址（如有）
- ✅ **所属活动**：关联的活动（如有）

#### 🎨 视觉设计

**查看器布局**
```
┌─────────────────────────────────────────────────┐
│              照片名.jpg (1 / 100)                │
├─────────────────────────────────────────────────┤
│                                                 │
│  ⬅  ┌──────────────────┐  ┌──────────────┐  ➡ │
│     │                  │  │ 大小: 2.5 MB │     │
│     │                  │  │ 宽度: 4032 px│     │
│     │    照片预览      │  │ 高度: 3024 px│     │
│     │                  │  │ 描述: ...    │     │
│     │                  │  │ 时间: ...    │     │
│     │                  │  │ 标签: 旅行   │     │
│     └──────────────────┘  │ 地址: ...    │     │
│                           │ 所属活动: ...│     │
│                           └──────────────┘     │
└─────────────────────────────────────────────────┘
```

**布局特点：**
- 左侧图片自适应，最大高度 70vh
- 右侧固定宽度 400px，可独立滚动
- 信息面板单列展示，清晰易读
- 空值字段自动隐藏

#### 💡 功能特性

**1. 智能单位转换**
```typescript
formatFileSize(bytes) {
  0 B         → "0 B"
  1024 B      → "1.00 KB"
  1048576 B   → "1.00 MB"
  2621440 B   → "2.50 MB"
}
```

**2. 条件显示**
- 描述为空时不显示该字段
- 标签为空时不显示该字段
- 地址为空时不显示该字段
- 活动为空时不显示该字段

**3. 信息面板滚动**
- 当信息较多时，右侧面板可独立滚动
- 最大高度 70vh，与图片高度一致
- 保持界面整洁

#### 🔧 技术实现

**新增字段**
```typescript
// API 接口
export interface Photo {
  // ... 原有字段
  size: number          // 文件大小（字节）
  description: string   // 照片描述
}
```

**文件大小格式化**
```typescript
const formatFileSize = (bytes: number) => {
  if (!bytes) return '0 B'
  
  const units = ['B', 'KB', 'MB', 'GB', 'TB']
  const k = 1024
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  
  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + units[i]
}
```

**左右布局**
```vue
<div class="viewer-content">
  <!-- 左侧图片 -->
  <div class="viewer-image">
    <img :src="..." />
  </div>
  
  <!-- 右侧信息 -->
  <div class="viewer-info">
    <t-descriptions :column="1" bordered>
      <!-- 8个信息项 -->
    </t-descriptions>
  </div>
</div>
```

**样式要点**
```css
.viewer-content {
  display: flex;
  gap: 24px;
}

.viewer-image {
  flex: 1;              /* 占据剩余空间 */
}

.viewer-info {
  width: 400px;         /* 固定宽度 */
  flex-shrink: 0;       /* 不收缩 */
  max-height: 70vh;     /* 最大高度 */
  overflow-y: auto;     /* 独立滚动 */
}
```

#### 📊 信息展示对比

| 信息项 | 之前 | 现在 |
|--------|------|------|
| 大小 | ❌ | ✅ 2.50 MB |
| 宽度 | ✅ 宽×高 | ✅ 4032 px |
| 高度 | ✅ 宽×高 | ✅ 3024 px |
| 描述 | ❌ | ✅ 照片描述 |
| 时间 | ✅ 拍摄日期 | ✅ 拍摄时间 |
| 标签 | ✅ | ✅ |
| 地址 | ✅ 位置 | ✅ 地址 |
| 所属活动 | ✅ 活动 | ✅ 所属活动 |

#### 🎯 用户体验

**优点：**
- ✅ 信息更完整（新增大小和描述）
- ✅ 布局更清晰（左右分离）
- ✅ 阅读更方便（单列展示）
- ✅ 空间利用更好（右侧固定宽度）
- ✅ 信息独立滚动（不影响图片查看）

**使用场景：**
- 查看照片详细参数
- 了解照片大小
- 查看拍摄信息
- 查看关联的活动和标签

#### 🐛 已修复

- 信息展示不完整（缺少大小和描述）
- 布局拥挤（之前在底部单行显示）
- 宽高显示不清晰（之前合并为"尺寸"）
- 信息过多时难以查看

#### 💡 提示

**查看照片信息：**
1. 点击照片打开查看器
2. 右侧自动显示完整信息
3. 信息较多时可滚动查看
4. 按 ← → 切换照片，信息同步更新

**文件大小：**
- 自动转换为合适的单位
- 保留两位小数
- 便于了解存储空间

---

## v1.5.1 - 2025-12-16

### 🔧 优化：标签搜索改为下拉选择

将标签搜索从输入框改为下拉选择框，提升用户体验。

#### 🎯 核心改进

**1. 下拉选择**
- ✅ 使用 `t-select` 替代 `t-input`
- ✅ 自动加载所有可用标签
- ✅ 支持点击选择标签
- ✅ 支持输入搜索过滤（filterable）

**2. 交互优化**
- ✅ 清晰显示所有标签选项
- ✅ 支持清空按钮快速清除
- ✅ 支持输入关键词过滤标签
- ✅ 图标改为标签图标（discount）

#### 🎨 视觉设计

**下拉框**
```
┌──────────────────┐
│ 🏷️ 选择标签    ▼ │
└──────────────────┘
        ↓ 点击展开
┌──────────────────┐
│ 旅行             │
│ 美食             │
│ 风景             │
│ 家人             │
│ ...              │
└──────────────────┘
```

**特性：**
- 宽度：200px
- 可清空：clearable
- 可搜索：filterable
- 自动加载：启动时获取所有标签

#### 💡 使用方式

**场景1：选择标签**
```
1. 点击"选择标签"下拉框
2. 从列表中选择标签
3. 自动筛选照片
```

**场景2：搜索标签**
```
1. 点击下拉框
2. 输入关键词（如"旅"）
3. 自动过滤匹配的标签
4. 选择目标标签
```

**场景3：清除筛选**
```
1. 点击下拉框右侧的 ✕ 按钮
2. 清空标签筛选
3. 显示所有照片
```

#### 🔧 技术实现

**加载所有标签**
```typescript
const allTags = ref<string[]>([])

const loadAllTags = async () => {
  try {
    const res = await getAllTagsApi()
    if (res.code === 0) {
      allTags.value = res.data
    }
  } catch (error) {
    console.error('Load tags error:', error)
  }
}

// 启动时加载
onMounted(async () => {
  await Promise.all([loadCount(), loadAllTags()])
  // ...
})
```

**下拉选择组件**
```vue
<t-select
  v-model="searchTag"
  placeholder="选择标签"
  clearable
  filterable
  style="width: 200px"
  @change="resetAndLoad"
>
  <template #prefix-icon>
    <t-icon name="discount" />
  </template>
  <t-option
    v-for="tag in allTags"
    :key="tag"
    :value="tag"
    :label="tag"
  />
</t-select>
```

#### 📊 对比

| 特性 | 之前（输入框） | 现在（下拉选择） |
|------|--------------|----------------|
| 标签发现 | 需要记住标签名 | 直接显示所有标签 ⭐⭐⭐⭐⭐ |
| 输入方式 | 手动输入 | 点击选择 ⭐⭐⭐⭐⭐ |
| 搜索功能 | 不支持 | 支持过滤 ⭐⭐⭐⭐⭐ |
| 清空操作 | ✅ | ✅ |
| 易用性 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

#### 🎯 用户体验

**优点：**
- ✅ 不需要记住标签名称
- ✅ 一目了然所有可用标签
- ✅ 点击即可快速筛选
- ✅ 支持输入搜索长标签列表
- ✅ 避免输入错误

**适用场景：**
- 查看系统中有哪些标签
- 快速按标签筛选照片
- 探索不同标签的照片

#### 🐛 已修复

- 输入框需要手动输入标签名
- 不知道系统中有哪些标签
- 可能输入不存在的标签

#### 💡 提示

**快速使用：**
1. 点击下拉框查看所有标签
2. 点击标签即可筛选
3. 点击 ✕ 清除筛选

**搜索标签：**
1. 点击下拉框
2. 输入关键词
3. 从过滤结果中选择

---

## v1.5.0 - 2025-12-16

### ✨ 新功能：选择模式切换

优化照片选择交互，新增选择模式开关，区分浏览和选择两种场景。

#### 🎯 核心功能

**1. 选择模式开关**
- ✅ 右上角新增"选择"按钮
- ✅ 点击切换选择/浏览模式
- ✅ 选择模式下按钮高亮显示
- ✅ 退出选择模式自动清除选择

**2. 两种交互模式**

**浏览模式（默认）：**
- ✅ 点击照片直接查看大图
- ✅ 选中照片只显示蓝色边框高亮
- ✅ 不显示选择框
- ✅ 不支持 Ctrl/Shift 多选
- ✅ 适合快速浏览照片

**选择模式：**
- ✅ 点击照片切换选中状态
- ✅ 右上角显示选择框图标
- ✅ 支持 Ctrl 单独选择
- ✅ 支持 Shift 连续选择
- ✅ 适合批量操作

#### 🎨 视觉设计

**选择按钮**
```
┌──────────────────────────────────┐
│ 筛选器...        [☑️ 选择] [↑回顶] │
└──────────────────────────────────┘
           未选中: ○ 选择
           已选中: ☑️ 退出选择 (蓝色)
```

**浏览模式**
```
┌────────┐
│  照片  │  ← 蓝色边框（选中）
│        │  
└────────┘
   只有边框，无选择框
```

**选择模式**
```
┌────────┐
│  照片  │☑️  ← 右上角选择框
│        │
└────────┘
   蓝色边框 + 选择框
```

#### 💡 使用场景

**场景1：快速浏览**
```
1. 默认浏览模式
2. 点击照片查看大图
3. 按 ← → 切换照片
4. 按 Esc 关闭，自动定位
```

**场景2：批量操作**
```
1. 点击右上角"选择"按钮
2. 进入选择模式
3. 点击或 Ctrl/Shift 多选照片
4. 执行批量操作
5. 点击"退出选择"返回浏览模式
```

**场景3：混合使用**
```
1. 浏览模式下查看照片
2. 关闭后照片被选中（蓝色边框）
3. 点击"选择"进入选择模式
4. 继续多选其他照片
5. 批量收藏/删除
```

#### 🔧 技术实现

**选择模式状态**
```typescript
const selectionMode = ref(false)  // 选择模式开关

// 切换选择模式
const toggleSelectionMode = () => {
  selectionMode.value = !selectionMode.value
  
  // 退出选择模式时清除选择
  if (!selectionMode.value) {
    clearSelection()
  }
}
```

**点击事件处理**
```typescript
const handlePhotoClick = (photo, event) => {
  if (selectionMode.value) {
    // 选择模式：支持多选
    if (event.ctrlKey) {
      toggleSelection(photo)      // Ctrl: 单独选择
    } else if (event.shiftKey) {
      selectRange(photo)          // Shift: 连续选择
    } else {
      toggleSelection(photo)      // 普通: 切换选择
    }
  } else {
    // 浏览模式：直接查看
    viewPhoto(photo)
  }
}
```

**选择框显示**
```vue
<!-- 选择模式下显示选择框 -->
<div v-if="selectionMode" class="selection-checkbox">
  <t-icon :name="selectedPhotos.has(photo.id) 
    ? 'check-circle-filled' 
    : 'circle'" />
</div>
```

#### 📊 行为对比

| 操作 | 浏览模式 | 选择模式 |
|------|---------|---------|
| 点击照片 | 查看大图 | 切换选中 |
| Ctrl+点击 | 查看大图 | 单独选择 |
| Shift+点击 | 查看大图 | 连续选择 |
| 选择框 | 隐藏 | 显示 |
| 蓝色边框 | ✅ 显示 | ✅ 显示 |
| 右上按钮 | "选择" | "退出选择"(蓝色) |

#### 🎯 设计理念

**1. 模式分离**
- 浏览和选择是两种不同的心智模型
- 浏览时应该快速直接
- 选择时才需要复杂的多选功能

**2. 渐进式增强**
- 默认是简单的浏览模式
- 需要时进入选择模式
- 清晰的模式切换反馈

**3. 保持一致性**
- 两种模式都保留蓝色边框高亮
- 查看器关闭后的选中状态保持
- 可以无缝切换模式继续操作

#### 🎨 交互流程

**浏览 → 选择：**
```
1. 浏览照片，点击查看
2. 关闭后照片被选中（蓝色边框）
3. 点击"选择"按钮
   ↓
✅ 进入选择模式
✅ 已选中的照片显示选择框
✅ 可以继续多选其他照片
```

**选择 → 浏览：**
```
1. 选择模式下选中多张照片
2. 点击"退出选择"
   ↓
✅ 返回浏览模式
✅ 所有选择被清除
✅ 点击照片直接查看
```

#### 🐛 已修复

- 浏览模式下 Ctrl/Shift 点击会触发多选
- 选择框与操作菜单重叠问题
- 模式切换时的状态同步
- 选择框的视觉层级

#### 💡 提示

**浏览照片：**
- 默认模式，点击直接查看
- 查看器关闭后照片会被选中（边框高亮）
- 简单快速

**批量操作：**
1. 点击右上角"选择"按钮
2. 进入选择模式（显示选择框）
3. 使用 Ctrl/Shift 多选
4. 执行批量操作
5. 点击"退出选择"返回

**混合使用：**
- 查看器关闭后的选中照片（蓝色边框）
- 可以直接切换到选择模式
- 继续多选其他照片

---

## v1.4.2 - 2025-12-10

### ✨ 新功能：关闭查看器后自动定位

关闭照片查看器后，自动滚动到当前照片位置并选中，方便继续浏览。

#### 🎯 核心功能

**1. 自动滚动定位**
- ✅ 按 Esc 关闭查看器后
- ✅ 自动滚动到当前查看的照片
- ✅ 照片居中显示在屏幕中
- ✅ 平滑滚动动画

**2. 自动选中照片**
- ✅ 清除之前的选择
- ✅ 选中当前查看的照片
- ✅ 蓝色边框高亮显示
- ✅ 方便继续操作

**3. 智能加载**
- ✅ 自动加载目标位置的照片数据
- ✅ 确保照片可见
- ✅ 无缝衔接

#### 💡 使用场景

**场景1：浏览后继续操作**
```
1. 点击第 50 张照片查看
2. 按 → → → 切换到第 60 张
3. 按 Esc 关闭查看器
   ↓
✅ 自动滚动到第 60 张位置
✅ 第 60 张被选中（蓝色边框）
✅ 可以直接 Ctrl+点击其他照片多选
```

**场景2：快速定位**
```
1. 在列表顶部，点击某张照片
2. 在查看器中浏览多张照片
3. 关闭查看器
   ↓
✅ 列表自动滚动到最后查看的照片
✅ 该照片被选中
✅ 不会迷失在长列表中
```

**场景3：跨页浏览**
```
1. 当前在第 1 页位置
2. 查看照片，按 → 切换到第 100 张
3. 关闭查看器
   ↓
✅ 自动滚动到第 100 张位置
✅ 自动加载该位置的照片数据
✅ 第 100 张被选中
```

#### 🔧 技术实现

**1. 滚动到照片位置**
```typescript
const scrollToPhoto = async (photoIndex: number) => {
  // 确保照片数据已加载
  await ensurePhotoLoaded(photoIndex)
  
  // 计算照片所在的行
  const row = Math.floor(photoIndex / itemsPerRow.value)
  
  // 计算滚动位置（居中显示）
  const targetScrollTop = row * itemHeight 
    - containerHeight.value / 2 
    + itemHeight / 2
  
  // 平滑滚动
  scrollContainer.value.scrollTo({
    top: Math.max(0, targetScrollTop),
    behavior: 'smooth'
  })
  
  // 等待渲染完成
  await nextTick()
  await new Promise(resolve => setTimeout(resolve, 300))
}
```

**2. 关闭时处理**
```typescript
const handleViewerClosed = async () => {
  // 移除键盘监听
  window.removeEventListener('keydown', handleKeyDown)
  
  // 如果有当前照片
  if (currentPhoto.value && currentPhotoIndex.value >= 0) {
    // 清空之前的选择
    selectedPhotos.value.clear()
    
    // 选中当前照片
    selectedPhotos.value.add(currentPhoto.value.id)
    lastSelectedIndex.value = currentPhotoIndex.value
    
    // 滚动到照片位置（居中）
    await scrollToPhoto(currentPhotoIndex.value)
  }
}
```

**3. 居中算法**
```typescript
// 目标滚动位置 = 照片行位置 - 半个屏幕 + 半个照片高度
targetScrollTop = row * itemHeight           // 照片顶部
                - containerHeight / 2        // 向上偏移半屏
                + itemHeight / 2             // 向下偏移半个照片

结果：照片显示在屏幕正中央
```

#### 🎨 视觉效果

**关闭前：**
```
[查看器]
┌─────────────────────┐
│  第 60 张照片       │
│                     │
│  详细信息...        │
└─────────────────────┘
```

**按 Esc 后：**
```
列表自动滚动到：

   ┌────┬────┬────┬────┬────┐
   │ 56 │ 57 │ 58 │ 59 │ 60 │
   └────┴────┴────┴────┴────┘
                        ↑
                    蓝色边框
                    (选中状态)

照片居中显示在屏幕中
```

#### 📊 用户体验提升

| 场景 | 之前 | 现在 |
|------|------|------|
| 关闭查看器 | 停留在原位置 | 自动滚动到当前照片 ⭐⭐⭐⭐⭐ |
| 照片定位 | 需要手动查找 | 自动居中显示 ⭐⭐⭐⭐⭐ |
| 继续操作 | 不知道看到哪了 | 照片已选中，可继续 ⭐⭐⭐⭐⭐ |
| 跨页浏览 | 回到顶部 | 自动加载并定位 ⭐⭐⭐⭐⭐ |

#### 💡 优势

**1. 上下文保持**
- 知道刚才看到哪张照片了
- 可以直接继续操作（多选、删除等）
- 不会在长列表中迷失

**2. 操作连贯性**
- 查看 → 关闭 → 继续操作，一气呵成
- 选中状态方便下一步操作
- 符合用户心理预期

**3. 智能处理**
- 自动加载所需数据
- 居中显示，视觉最佳
- 平滑动画，不突兀

#### 🎯 工作流程

```
1. 用户在查看器中浏览照片
   currentPhotoIndex = 60
   
2. 按 Esc 关闭查看器
   ↓
   触发 handleViewerClosed()
   
3. 清除之前的选择
   selectedPhotos.clear()
   
4. 选中当前照片
   selectedPhotos.add(currentPhoto.id)
   
5. 滚动到照片位置
   scrollToPhoto(60)
   ├─ ensurePhotoLoaded(60)  // 确保数据加载
   ├─ 计算滚动位置（居中）
   └─ 平滑滚动
   
6. 完成
   ✅ 照片在屏幕中央
   ✅ 蓝色边框选中状态
   ✅ 可以继续操作
```

#### 🐛 已修复

- 关闭查看器后停留在原位置
- 不知道刚才看的是哪张照片
- 需要手动滚动查找
- 跨页浏览后回到顶部

#### 💡 提示

**查看器使用技巧：**
1. 点击照片打开查看器
2. 使用 ← → 键浏览多张照片
3. 按 Esc 关闭
4. 自动定位到最后查看的照片
5. 该照片已被选中，可继续操作

**配合多选功能：**
1. 查看器中浏览到某张照片
2. 按 Esc 关闭（照片被选中）
3. Ctrl + 点击其他照片
4. 批量操作

---

## v1.4.1 - 2025-12-10

### 🔧 优化：照片切换加载状态

优化照片切换时的加载体验，防止快速切换导致的问题。

#### 🎯 核心改进

**1. 加载状态管理**
- ✅ 照片切换时显示加载中状态
- ✅ 加载完成前禁用导航按钮
- ✅ 加载完成前阻止键盘输入
- ✅ 防止快速连续切换

**2. 视觉反馈**
- ✅ 中央显示大号 Loading 图标
- ✅ 半透明白色遮罩层
- ✅ "加载中..." 文字提示
- ✅ 导航按钮显示 loading 状态

**3. 错误处理**
- ✅ 图片加载失败时提示用户
- ✅ 自动恢复可操作状态
- ✅ 不会卡在加载状态

#### 🎨 视觉设计

**加载中状态**
```
┌─────────────────────────────────┐
│                                 │
│          ┌──────────┐          │
│          │  🔄      │          │
│          │ 加载中... │          │
│          └──────────┘          │
│                                 │
└─────────────────────────────────┘
```

**导航按钮状态**
- 加载中：按钮显示 loading 图标
- 加载中：按钮禁用（不可点击）
- 加载完成：按钮恢复正常

#### 💡 工作流程

**正常切换：**
```
1. 按下 → 键
2. 显示加载遮罩
3. 加载照片数据
4. 加载图片文件
5. 图片加载完成
6. 隐藏加载遮罩
7. 可以继续操作
```

**快速连续切换：**
```
1. 按下 → 键（第一次）
2. 显示加载遮罩
3. 再按 → 键（第二次）
   ❌ 被阻止，因为正在加载
4. 等待第一次加载完成
5. 可以继续操作
```

#### 🔧 技术实现

**状态标志**
```typescript
const photoSwitching = ref(false)  // 切换中状态
```

**防止重复切换**
```typescript
const viewNextPhoto = async () => {
  // 如果正在切换，直接返回
  if (photoSwitching.value) return
  
  photoSwitching.value = true  // 标记为切换中
  
  try {
    // 加载照片数据
    await ensurePhotoLoaded(newIndex)
    // 更新当前照片
    currentPhoto.value = photo
  } catch (error) {
    // 出错时恢复状态
    photoSwitching.value = false
  }
  
  // 图片加载完成时才会重置状态（在 @load 事件中）
}
```

**图片加载事件**
```vue
<img
  v-show="!photoSwitching"
  :key="currentPhoto.id"
  @load="handleImageLoaded"
  @error="handleImageError"
/>
```

**禁用键盘输入**
```typescript
const handleKeyDown = (event: KeyboardEvent) => {
  // 切换中时不处理任何按键
  if (photoSwitching.value) return
  
  if (event.key === 'ArrowLeft') {
    viewPrevPhoto()
  }
}
```

**禁用按钮点击**
```vue
<t-button
  :disabled="photoSwitching"
  :loading="photoSwitching"
>
```

#### 📊 对比

| 场景 | 之前 | 现在 |
|------|------|------|
| 快速按键 | 多次切换，卡顿 | 阻止重复，流畅 ⭐⭐⭐⭐⭐ |
| 加载反馈 | 无提示 | 显示 Loading ⭐⭐⭐⭐⭐ |
| 加载失败 | 卡住 | 提示错误并恢复 ⭐⭐⭐⭐⭐ |
| 用户体验 | 不确定性 | 清晰反馈 ⭐⭐⭐⭐⭐ |

#### 🎯 用户体验

**优点：**
- ✅ 明确的加载状态反馈
- ✅ 防止误操作
- ✅ 不会因快速切换而卡顿
- ✅ 加载失败有错误提示
- ✅ 自动恢复到可操作状态

**交互流程：**
```
用户按键 → 显示加载中 → 禁用操作 
→ 加载完成 → 隐藏加载 → 恢复操作
```

#### 🐛 已修复

- 快速连续按键导致的卡顿
- 图片未加载完就切换到下一张
- 网络慢时用户不知道是否在加载
- 加载失败时界面卡住
- 按钮可以重复点击

#### 💡 技术细节

**加载状态生命周期：**
1. **开始切换**：`photoSwitching = true`
2. **加载数据**：从缓存或 API 获取
3. **更新照片**：切换到新照片
4. **加载图片**：浏览器加载图片文件
5. **图片完成**：触发 `@load` 事件
6. **结束加载**：`photoSwitching = false`

**关键点：**
- 使用 `:key` 强制重新加载图片
- 使用 `v-show` 而不是 `v-if`（保持 DOM）
- 同时禁用键盘和按钮
- 错误处理确保状态恢复

---

## v1.4.0 - 2025-12-10

### ✨ 新功能：照片查看器支持键盘导航

在照片查看器中支持使用键盘快捷键浏览照片。

#### 🎯 核心功能

**1. 键盘快捷键**
- ✅ **←** 左箭头：查看上一张照片
- ✅ **→** 右箭头：查看下一张照片
- ✅ **Esc**：关闭查看器

**2. 导航按钮**
- ✅ 左右两侧显示导航按钮
- ✅ 按钮半透明，毛玻璃效果
- ✅ 悬停时放大效果
- ✅ 到达边界时自动隐藏

**3. 智能索引**
- ✅ 标题栏显示当前位置（如：1 / 100）
- ✅ 自动计算照片在列表中的位置
- ✅ 支持跨分页切换
- ✅ 自动加载缺失的照片数据

#### 🎨 视觉设计

**标题栏信息**
```
照片名称.jpg (23 / 156)
         ↑    ↑    ↑
       名称  当前  总数
```

**导航按钮**
- 位置：图片两侧（左右各一个）
- 样式：圆形大按钮
- 背景：半透明白色 + 毛玻璃
- 图标：大号箭头（24px）
- 效果：悬停放大 1.1 倍

**按钮布局**
```
┌─────────────────────────────┐
│                             │
│  ⬅                    ➡   │
│        📷 照片              │
│                             │
└─────────────────────────────┘
```

#### 💡 使用场景

**场景1：连续浏览照片**
```
1. 点击任意照片打开查看器
2. 按 → 键查看下一张
3. 按 ← 键查看上一张
4. 按 Esc 关闭
```

**场景2：快速翻阅**
```
1. 打开第一张照片
2. 连续按 → 键快速浏览所有照片
3. 标题栏显示当前进度
```

**场景3：使用鼠标**
```
1. 点击照片打开
2. 点击左侧按钮 ⬅ 或右侧按钮 ➡
3. 同样可以切换照片
```

#### 🔧 技术实现

**1. 索引计算**
```typescript
// 打开照片时计算索引
const allPhotos = getAllPhotosInOrder()
currentPhotoIndex.value = allPhotos.findIndex(p => p.id === photo.id)
```

**2. 跨分页加载**
```typescript
// 确保目标照片已加载
const ensurePhotoLoaded = async (index: number) => {
  const cacheKey = Math.floor(index / pageSize) * pageSize
  
  if (!photoCache.value.has(cacheKey)) {
    await loadPhotos(cacheKey, pageSize)
  }
}
```

**3. 键盘事件监听**
```typescript
const handleKeyDown = (event: KeyboardEvent) => {
  if (event.key === 'ArrowLeft') {
    viewPrevPhoto()  // 上一张
  } else if (event.key === 'ArrowRight') {
    viewNextPhoto()  // 下一张
  } else if (event.key === 'Escape') {
    viewerVisible.value = false  // 关闭
  }
}

// 查看器打开时注册监听
handleViewerOpened() {
  window.addEventListener('keydown', handleKeyDown)
}

// 查看器关闭时移除监听
handleViewerClosed() {
  window.removeEventListener('keydown', handleKeyDown)
}
```

**4. 边界处理**
```typescript
// 是否有上一张
const hasPrevPhoto = computed(() => {
  return currentPhotoIndex.value > 0
})

// 是否有下一张
const hasNextPhoto = computed(() => {
  return currentPhotoIndex.value < totalCount.value - 1
})
```

#### 📊 交互优化

| 操作 | 方式 | 说明 |
|------|------|------|
| 下一张 | → 键 | 快速切换 |
| 上一张 | ← 键 | 快速切换 |
| 关闭 | Esc 键 | 快速退出 |
| 下一张 | 点击右侧按钮 | 鼠标操作 |
| 上一张 | 点击左侧按钮 | 鼠标操作 |

#### 🎯 用户体验

**优点：**
- ✅ 无需关闭再打开，连续浏览
- ✅ 键盘操作更快捷
- ✅ 实时显示当前位置
- ✅ 自动加载所需数据
- ✅ 到达边界时按钮自动隐藏

**智能特性：**
- 自动计算照片索引位置
- 按需加载分页数据
- 防止重复加载
- 事件监听自动清理

#### 🐛 已修复

- 键盘事件在查看器关闭后继续触发
- 跨分页切换时照片未加载
- 边界情况下的按钮显示
- 索引计算错误

#### 💡 提示

**键盘快捷键：**
- `←` 上一张
- `→` 下一张
- `Esc` 关闭

**鼠标操作：**
- 点击左右两侧的圆形按钮

**查看进度：**
- 标题栏显示：`照片名 (当前 / 总数)`

---

## v1.3.0 - 2025-12-10

### ✨ 优化：操作菜单收起

优化照片操作按钮的交互设计，防止误触，提升用户体验。

#### 🎯 核心改进

**1. 收起操作按钮**
- ✅ 将"收藏"和"删除"按钮收起到"更多操作"菜单
- ✅ 右上角显示圆形菜单按钮（三个点图标）
- ✅ 只有鼠标悬停时才显示菜单按钮
- ✅ 点击菜单按钮展开下拉菜单

**2. 新增收藏标记**
- ✅ 已收藏的照片左上角显示黄色星星小标记
- ✅ 一眼识别收藏状态
- ✅ 不占用主要操作区域

**3. 防误触设计**
- ✅ 默认隐藏操作按钮
- ✅ 需要主动悬停才显示
- ✅ 需要点击菜单才能操作
- ✅ 两步操作，降低误触概率

#### 🎨 视觉设计

**菜单按钮**
- 半透明白色背景（95% 透明度）
- 毛玻璃效果（backdrop-filter: blur）
- 圆形按钮设计
- 悬停时变为纯白色

**收藏标记**
- 位置：左上角
- 图标：黄色实心星星
- 大小：16px
- 背景：白色圆形

**下拉菜单**
- 最小宽度：120px
- 位置：右下对齐
- 图标 + 文字
- 删除选项使用红色主题

#### 💡 交互流程

**之前（容易误触）：**
```
悬停照片 → 显示按钮覆盖层 → 容易误点
```

**现在（防误触）：**
```
1. 悬停照片 → 右上角显示菜单按钮
2. 点击菜单按钮 → 展开下拉菜单
3. 点击具体操作 → 执行操作
```

#### 🔧 技术实现

**菜单结构**
```vue
<t-dropdown trigger="click" placement="bottom-right">
  <t-button shape="circle" class="menu-trigger">
    <t-icon name="ellipsis" />
  </t-button>
  
  <t-dropdown-menu>
    <t-dropdown-item @click="toggleStar(photo)">
      <template #prefix-icon>
        <t-icon name="star" />
      </template>
      收藏/取消收藏
    </t-dropdown-item>
    
    <t-dropdown-item theme="error" @click="trashPhoto(photo)">
      <template #prefix-icon>
        <t-icon name="delete" />
      </template>
      删除
    </t-dropdown-item>
  </t-dropdown-menu>
</t-dropdown>
```

**样式要点**
```css
.action-menu {
  opacity: 0;  /* 默认隐藏 */
  transition: opacity 0.2s;
}

.photo-wrapper:hover .action-menu {
  opacity: 1;  /* 悬停显示 */
}

/* 有选中标记时，菜单按钮向左移动避免重叠 */
.photo-selected .action-menu {
  right: 40px;
}
```

#### 📊 对比

| 特性 | 之前 | 现在 |
|------|------|------|
| 操作步骤 | 1步（直接点击） | 2步（菜单 → 操作） |
| 误触概率 | 高 | 低 |
| 收藏识别 | 需要悬停查看 | 直接显示星标 |
| 视觉干扰 | 悬停有覆盖层 | 只有小按钮 |
| 操作安全性 | 低 | 高 |

#### 🎯 用户体验

**照片列表：**
- 浏览照片时不会有操作按钮干扰
- 收藏的照片一眼可识别（黄色星星）
- 需要操作时，悬停显示菜单按钮
- 点击菜单选择具体操作

**回收站：**
- 同样使用菜单方式
- 只有"恢复"一个操作
- 防止误触恢复

#### 🐛 已修复

- 菜单按钮与选中标记重叠问题（自动向左移动）
- 菜单按钮的 z-index 层级
- 点击菜单按钮不触发照片选择
- 遮罩层透明度优化（降低干扰）

---

## v1.2.0 - 2025-12-10

### ✨ 新功能：照片多选

实现了照片多选功能，支持 Shift 连续选择和 Ctrl 单独选择。

#### 🎯 核心特性

**1. 三种选择方式**
- ✅ **普通点击**：切换当前照片的选中状态
- ✅ **Ctrl/Cmd + 点击**：单独选择或取消选择照片（不影响其他照片）
- ✅ **Shift + 点击**：连续选择从上次选中到当前照片之间的所有照片

**2. 视觉反馈**
- ✅ 选中的照片有蓝色边框高亮
- ✅ 右上角显示蓝色勾选图标
- ✅ 缩放效果区分选中状态
- ✅ 顶部显示已选择数量

**3. 选择管理**
- ✅ 显示"已选择 X 张"
- ✅ 一键清除所有选择
- ✅ 切换过滤条件自动清除选择

#### 🔧 技术实现

**状态管理**
```typescript
// 使用 Set 存储选中的照片 ID
const selectedPhotos = ref<Set<number>>(new Set())

// 记录最后选中的索引（用于 Shift 连续选择）
const lastSelectedIndex = ref<number>(-1)
```

**点击事件处理**
```typescript
handlePhotoClick(photo, event) {
  if (event.ctrlKey || event.metaKey) {
    // Ctrl/Cmd: 单独切换
    toggleSelection(photo)
  } else if (event.shiftKey && lastSelectedIndex >= 0) {
    // Shift: 连续选择
    selectRange(photo)
  } else {
    // 普通点击: 切换选择
    toggleSelection(photo)
  }
}
```

**连续选择算法**
```typescript
selectRange(photo) {
  // 1. 获取所有照片（按顺序）
  const allPhotos = getAllPhotosInOrder()
  
  // 2. 找到起始和结束索引
  const start = Math.min(lastSelectedIndex, currentIndex)
  const end = Math.max(lastSelectedIndex, currentIndex)
  
  // 3. 选中范围内的所有照片
  for (let i = start; i <= end; i++) {
    selectedPhotos.add(allPhotos[i].id)
  }
}
```

#### 🎨 用户体验

**照片列表 (Photos.vue)**
1. 点击照片 → 选中（显示蓝色边框和勾选图标）
2. 再次点击 → 取消选中
3. Ctrl + 点击多张照片 → 单独选择
4. 点击第一张，Shift + 点击第五张 → 选中 1-5 张
5. 顶部显示"已选择 X 张"
6. 点击"清除选择"清空

**回收站 (Trash.vue)**
- 同样支持多选功能
- 可以配合批量操作使用

**行为说明**
- 在照片列表中，首次点击会选中照片（不打开预览）
- 只有当没有选中任何照片时，点击才会打开预览
- 在回收站中，所有点击都是选择操作

#### 💡 使用场景

**适合：**
- ✅ 批量收藏照片
- ✅ 批量删除照片
- ✅ 批量下载照片（待实现）
- ✅ 批量添加标签（待实现）
- ✅ 批量移动相册（待实现）

**操作技巧：**
```
场景1：选择相邻的照片
  1. 点击第一张照片
  2. Shift + 点击最后一张
  ✅ 中间所有照片都被选中

场景2：选择不相邻的照片
  1. 点击第一张
  2. Ctrl + 点击第三张
  3. Ctrl + 点击第五张
  ✅ 只选中了 1、3、5 张

场景3：取消某个选中
  1. 已选中多张照片
  2. Ctrl + 点击其中一张
  ✅ 取消该照片的选中状态

场景4：清空所有选择
  点击顶部的"清除选择"按钮
  ✅ 所有照片取消选中
```

#### 🎯 视觉设计

**选中状态样式**
- 蓝色边框：`box-shadow: 0 0 0 3px var(--td-brand-color)`
- 缩放效果：`transform: scale(0.95)`
- 勾选图标：右上角白色圆形背景
- 颜色主题：使用 TDesign 品牌色

**交互效果**
- 选中时有缩放动画
- 鼠标悬停时上移效果
- 流畅的过渡动画：`transition: all 0.2s`

#### 🐛 已修复

- 切换过滤条件时清除选择状态
- 虚拟滚动时正确维护选择状态
- Shift 选择时正确处理缓存中的照片顺序
- 选择信息实时更新

#### 🔜 后续规划

- [ ] 批量下载选中的照片
- [ ] 批量添加/修改标签
- [ ] 批量移动到相册
- [ ] 全选/反选功能
- [ ] 批量收藏/取消收藏

---

## v1.1.0 - 2025-12-10

### ✨ 新功能：虚拟滚动

实现了真正的虚拟滚动功能，支持直接拖动滚动条到任意位置浏览照片。

#### 🎯 核心特性

**1. 自由滚动**
- ✅ 滚动条可以拖动到任意位置
- ✅ 根据滚动位置按需加载照片
- ✅ 智能缓存机制，避免重复加载
- ✅ 平滑流畅的滚动体验

**2. 虚拟渲染**
- ✅ 只渲染可视区域内的照片
- ✅ 自动计算可见范围
- ✅ 添加缓冲区（前后各3行）
- ✅ 动态高度计算

**3. 性能优化**
- ✅ 分页缓存（每次100张照片）
- ✅ 并行加载多个分页
- ✅ 最小化 DOM 节点数量
- ✅ 懒加载图片

#### 🔧 技术实现

**虚拟滚动原理**
```typescript
// 1. 创建虚拟占位空间（总高度）
totalHeight = 总行数 × 行高

// 2. 计算可见范围
可见起始行 = 滚动位置 ÷ 行高
可见结束行 = (滚动位置 + 容器高度) ÷ 行高

// 3. 只渲染可见范围内的照片
可见照片 = 从缓存中提取 [起始索引, 结束索引]

// 4. 使用 transform 定位
offsetY = 可见起始行 × 行高
```

**分页缓存策略**
- 每次请求 100 张照片
- 缓存以 start 为 key
- 根据可见范围自动加载缺失的分页
- 并行请求多个分页

**自适应布局**
- 根据容器宽度自动计算每行显示数量
- 窗口大小改变时重新计算
- 响应式调整布局

#### 📊 性能对比

| 特性 | 传统分页 | 顺序滚动 | 虚拟滚动 |
|------|---------|---------|---------|
| 初始加载 | 50张 | 50张 | 按需 |
| DOM节点 | 固定50个 | 累积增加 | 固定~150个 |
| 内存占用 | 低 | 逐渐增加 | 恒定 |
| 跳转任意位置 | ❌ | ❌ | ✅ |
| 滚动流畅度 | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 大数据支持 | ❌ | ❌ | ✅ |

#### 🎨 用户体验

**照片列表 (Photos.vue)**
1. 打开页面，自动加载可见区域的照片
2. 随意拖动滚动条到任何位置
3. 自动加载对应位置的照片
4. 向上/向下滚动都流畅加载
5. 切换过滤条件后重置滚动位置

**回收站 (Trash.vue)**
- 同样支持虚拟滚动
- 恢复照片后智能刷新
- 清空回收站后重置

#### 💡 使用场景

**适合：**
- ✅ 大量照片（1000+ 张）
- ✅ 需要快速定位到某个位置
- ✅ 频繁上下滚动浏览
- ✅ 低内存设备

**配置参数：**
```typescript
const itemHeight = 280  // 照片项高度
const itemsPerRow = 5   // 每行数量（自动计算）
const bufferSize = 3    // 缓冲行数
const pageSize = 100    // 每次加载数量
```

#### 🐛 已修复

- 切换过滤条件时清空缓存
- 删除/恢复照片后正确更新
- 窗口大小改变时重新计算布局
- 滚动到边界时的正确处理

---

## v1.0.0 - 2025-12-10 (之前版本)

### ✨ 初始版本：顺序无限滚动

实现了基本的无限滚动功能，向下滚动自动加载更多。

#### 特点
- 向下滚动自动加载
- 距离底部 200px 时触发
- 按顺序累积加载照片
- 显示"已加载 X / 总数"

#### 限制
- ❌ 不能跳转到任意位置
- ❌ 必须按顺序滚动
- ❌ DOM 节点累积增加
- ❌ 大数据量性能下降
